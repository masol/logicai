/**
总结：主题的建模要点
要点	说明
结构化	将主题定义为“对立概念 + 演化路径”
可追踪	在每个情节单元中标注主题贡献
可评估	用 LLM 评估主题一致性
可驱动	用主题指导情节生成方向


阶段	主题表达	情节单元设计
开端	主角逃避牺牲	拒绝参军、逃离责任
发展	被迫面对牺牲	朋友因他退缩而受伤
高潮	主动牺牲	为救他人放弃逃生机会
结局	牺牲的意义被认可	社会纪念，家人理解



const prompt: LLM提示模板 = {
  任务: "生成",
  上下文: {
    当前主题: "牺牲",
    当前阶段: "高潮",
    角色: 主角,
    前情: "主角一直逃避责任"
  },
  约束条件: [
    "必须体现主角主动牺牲",
    "情感弧线从恐惧到平静",
    "紧张度 ≥ 8"
  ]
}


class 主题管理器 {
  故事: 故事;

  constructor(故事: 故事) {
    this.故事 = 故事;
  }

  // 评估某个情节单元是否符合主题
  async 评估主题一致性(单元: 情节单元): Promise<number> {
    const prompt: LLM提示模板 = {
      角色: "主题分析师",
      任务: "评估",
      上下文: {
        主题: this.故事.主题列表,
        情节单元: 单元,
        已有情节: this.故事.情节单元.slice(-3) // 最近几个单元
      },
      约束条件: [
        "评分0-1",
        "分析该单元是否推进主题",
        "是否与角色弧一致"
      ],
      输出格式: "json"
    };

    const result = await llm.评估<{ 评分: number; 理由: string }>(prompt);
    return result.评分;
  }

  // 自动为情节单元打上主题标签
  async 标注主题(单元: 情节单元): Promise<void> {
    const 主题名称列表 = this.故事.主题列表.map(t => t.名称);
    
    const prompt: LLM提示模板 = {
      角色: "主题标注员",
      任务: "生成",
      上下文: { 单元, 主题列表: 主题名称列表 },
      约束条件: [
        "返回匹配的主题名称",
        "给出贡献度（0-1）",
        "说明表达方式"
      ],
      输出格式: "json"
    };

    const 标注结果 = await llm.生成<{
      主题名称: string;
      贡献度: number;
      表达方式: string;
    }[]>(prompt);

    单元.主题关联 = 标注结果;
  }

  // 生成主题演化曲线
  生成主题强度曲线(): { 阶段: string; 强度: number }[] {
    return this.故事.主题演化路径.map(p => ({
      阶段: p.阶段,
      强度: p.强度
    }));
  }
}


```json
{
  "主题": {
    "名称": "牺牲 vs 自我保存",
    "对立概念": ["自我保存", "牺牲"],
    "演化路径": ["逃避", "被迫", "主动", "被认可"]
  },
  "演化阶段": [
    {
      "阶段名": "逃避",
      "章节区间": "[1-400]",
      "主题张力": "逃避牺牲",
      "世界KPI": {
        "体温计名称": "牺牲-保存温度计",
        "当前温": 20,
        "正常温": 37,
        "危险线": 70,
        "变化公式": "温度=保存值-牺牲值"
      },
      "冲突根": "主角生命 vs 他人生命",
      "出口果实": "拒绝参军令"
    },
    {
      "阶段名": "被迫",
      "章节区间": "[401-800]",
      "主题张力": "被迫面对牺牲",
      "世界KPI": {
        "当前温": 50,
        "变化公式": "保存值↓牺牲值↑"
      },
      "冲突根": "朋友因退缩受伤",
      "出口果实": "初次救人"
    },
    {
      "阶段名": "主动",
      "章节区间": "[801-1200]",
      "主题张力": "主动牺牲",
      "世界KPI": {
        "当前温": 80,
        "变化公式": "保存值↓↓牺牲值↑↑"
      },
      "冲突根": "为救他人放弃逃生",
      "出口果实": "自我牺牲被认可"
    },
    {
      "阶段名": "被认可",
      "章节区间": "[1201-1600]",
      "主题张力": "牺牲意义被社会承认",
      "世界KPI": {
        "当前温": 37,
        "变化公式": "保存值≈牺牲值"
      },
      "冲突根": "社会纪念 vs 个人记忆",
      "出口果实": "纪念碑立起"
  ]
}
```

 */

import { BaseModel, refprop } from "../../basemodel.js";



export class Synthesis extends BaseModel {
  static key = "Synthesis";
  static basePath = "synthesis"

  @refprop("name", "")
  name!: string
}